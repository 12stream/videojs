<template>
    <div class="personal-login">
        <Title :showtitle='personalLoginTitle' v-if="!weixinFlag"></Title>
        <div class="newphone-wrapper">
            <div class="newphone">
                <span>新手机号</span>
                <span class="distance">|</span>
                <input type="text" v-model="newphone" @input="entNewPhone">
            </div>
            <div class="newphone-code">
                <span>验证码</span>
                <input type="text" v-model="newcode" @input="entNewCode">
                <button :class="!disabledp ? 'getcode' : ''" @click="getCode" :disabled="disabledp">{{getCodeTitle}}</button>
            </div>
            <button :class="!disabledc ? 'ok' : ''" :disabled="disabledc" @click="submitok">提交</button>
        </div>
    </div>
</template>
<script>
import Title from '@/components/Title'
import {tfphoneNumber, is_weixn, is_QQ} from '@/utils/utils'
export default {
    data() {
        return {
            personalLoginTitle:'绑定新手机号',
            disabledp:true,
            disabledc:true,
            newphone:'',
            newcode:'',
            getCodeTitle:'获取验证码',
            phoneOk:false,
            weixinFlag:false
        }
    },
    components:{Title},
    methods:{
        entNewPhone() {
            if(tfphoneNumber(this.newphone-0)) {
                this.disabledp = false
            }else {
                this.disabledp = true
            }
            
        },
        entNewCode() {
            if(tfphoneNumber(this.newphone-0) && this.newcode !== '') {
                this.disabledc = false;
            }else {
                this.disabledc = true;
            }
        },
        getCode() {
            if(tfphoneNumber(this.newphone-0)) {
                this.$ajax.sendMessage({
                    mobile:this.newphone,
                }).then(res =>{
                    var index = 60;
                    // console.log(res)
                    if(res.code == 200) {
                        this.disabledp = true;
                        var timer = setInterval(() => {
                            index--
                            this.getCodeTitle = `重获验证码(${index})`
                            if(index == 0) {
                                this.getCodeTitle = '重获验证码'
                                this.disabledp = false;
                                clearInterval(timer)
                            }
                        },1000)
                    }
                })
            }
        },
        submitok() {
            var getUserId = localStorage.getItem('userid')
            if(tfphoneNumber(this.newphone-0) && this.newcode !== '') {
                this.$ajax.changePhoneNumber({
                    mobile:this.newphone,
                    sm_code:this.newcode,
                    user_id:getUserId,
                    isTip:0
                }).then(res =>{
                    if(res.code == 200) {
                        localStorage.setItem('mobile',this.newphone)
                        this.$toast('更换成功')
                    }
                })
            }
        }
    },
    mounted(){
        if(is_weixn() || is_QQ()) {
            this.weixinFlag = true
        }
    }
}
</script>
<style lang="scss">
.newphone-wrapper {
     width: 86%;
     margin: 0 auto;
    .newphone {
        border-bottom: 1px solid #E3E3E7;
        color: #4A4A4A;
        padding: 1.5rem 0;
        font-size: 1.4rem;
        margin-top: 0.3rem;
        .distance {
            padding: 0 1rem;
        }
    }
    .newphone-code {
        width: 100%;
        display: flex;
        justify-content: space-between;
        padding: 1.5rem 0;
        margin-top: 0.3rem;
        border-bottom: 1px solid #E3E3E7;
        span {
            min-width: 5rem;
        }
        button {
            min-width: 8rem;
            color:#9B9B9B;
            border: none;
            // background: #fff;
            &.getcode {
                color:rgba(255,102,51,1);
                border: none;
                background: #fff;
            }
        }
    }
    >button {
        width: 100%;
        height: 4rem;
        background: rgba(255,102,51,0.6);
        text-align: center;
        line-height: center;
        color: #fff;
        border: none;
        border-radius: 5rem;
        margin-top: 3.5rem;
        &.ok {
            background: rgba(255,102,51,1);
        }
    }
}
</style>


