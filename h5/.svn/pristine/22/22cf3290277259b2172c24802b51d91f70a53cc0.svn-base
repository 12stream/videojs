<template>
    <div class="live">
        <Title :showtitle='liveTitle' v-if="!weixinFlag"></Title>
        <div class="top-live">
            <span class="logo"></span>
            <div class="home-personal">
                <span class="personal-center" @click="$router.push({path:'/personal'})">个人中心</span>
                <span class="home goto" @click="$router.push({path:'/'})">返回首页</span>
            </div>
        </div>
        <!-- 直播状态 0：直播创建 预告 1：正在直播 2：直播回放 5：直播结束，无录像 -->
        <!-- 直播结束展示图片 -->
        <div class="play-live" v-if="headimgstate">
            <img :src="liveDetailsData.live_cover_url">
             <!-- 直播已结束 -->
            <div class="live-end" v-if="liveDetailsData.live_status == 5">
                直播已结束
            </div>
        </div>  
        <!-- 原生播放后台返回的拉流地址播放 -->
        <video id="example_video_1" class="video-js play-live" webkit-playsinline="" playsinline="" x5-playsinline="" x-webkit-airplay="allow"
            width="100%" height="100%" :src="liveDetailsData.play_m3u8_url" preload="true" :poster="liveDetailsData.live_cover_url" v-if="showVideoFlag">
        </video>
        <!-- 直播详情 -->
        <div class="livehomestate" v-if="headimgstate">
            <!-- 未到直播时倒计时 -->
            <div class="start-time" v-if="countDownState && liveDetailsData.live_status !== 5">
                <div class="start-title">离直播开始还有</div>
                <div class="time">
                    <span class="countdown-box" :id="`cdd${liveDetailsData.id}`"></span> <sub>天</sub> <span class="countdown-box" :id="`cdh${liveDetailsData.id}`"></span> <sub>时</sub> <span class="countdown-box" :id="`cdm${liveDetailsData.id}`"></span> <sub>分</sub> <span class="countdown-box" :id="`cds${liveDetailsData.id}`"></span><sub>秒</sub>
                    {{limiteTime(liveDetailsData.begin_time, liveDetailsData.id)}} 
                </div>
            </div>
            <div class="details">
                <div class="title">
                    <div class="live-title">{{liveDetailsData.live_name}}</div>
                    <div :class="liveDetailsData.live_status == 5 ? 'start-time-title end' : 'start-time-title'">开始时间：<Countdown :time='liveDetailsData.begin_time' :timeflag="true"></Countdown></div>
                    <div class="money" v-if="liveDetailsData.live_permit == 0 && liveDetailsData.live_status !== 5">
                        <span class="no-money">免费</span>
                    </div>
                    <div class="money" v-else-if="liveDetailsData.live_permit !== 0 && liveDetailsData.live_status !== 5">
                        <img src="./images/icon_fufei.png">
                        <span>￥{{liveDetailsData.view_pass}}</span>
                    </div>
                </div>
                <div class="introduction">
                    <h5>简介</h5>
                    <div v-if="introudeData.length !== 0" v-for="(item,i) in introudeData" :key="i" class="int-img">
                        <img :src="item.img_url" v-if="item.img_url"> 
                        <p v-else>{{item.img_text}}</p>
                    </div>
                    <div v-if="!liveDetailsData.live_text" class="no-introduct">
                        <img src="./images/no-introuduce.png">
                    </div>
                </div>
            </div>
            <div class="bottom-invitation-pay" v-if="showLCFlag">
                <span class="invitation" @click="invite">邀请</span>
                <span class="pay" @click="pay">{{payTitle}}</span>
            </div>
            <Login v-if="flag" :loginF="loginState"></Login>
            <div class="mask" v-if="flag"></div>
        </div>
        <!-- 直播间 -->
        <div class="livehome-wrapper" v-if="showVideoFlag">
            <div class="livehome">
                <div class="chat-detail-se" v-for="(item,i) in tabContents" :key="i">
                <div :class="currentTabsIndex == i ? 'tabs-item active' : 'tabs-item'" @click="selectTabs(i)">
                    {{item}}
                </div>
                </div>
            </div>
            <Chat :detail="liveDetailsData" v-show="currentTabsIndex == 0"></Chat>
            <Details :detail="liveDetailsData" :introu='introudeData' v-show="currentTabsIndex == 1"></Details>
            <List v-show="currentTabsIndex == 2"></List>
        </div>
        <!-- 邀请 -->
        <transition name="invite" v-if="inviteFlag">
            <div class="live-invite">
                <div class="card" @click="test">
                    <img src="./images/card.png">
                    <span>邀请卡</span>
                </div>
                <div class="cancel">取消</div>
            </div>
      </transition>
       <div class="mask" v-if="inviteFlag" @click="closeInvite"></div>
    </div>
</template>
<script>
import Countdown from '@/components/CountDown'
import Login from '@/components/LoginBox'
import Title from '@/components/Title'
import Chat from './live/Chat'
import Details from './live/Details'
import List from './live/List'
import { doubleCountHandle, is_weixn, is_QQ } from '@/utils/utils.js'
import eventVue from '@/components/eventVue.js'
import {getLStorage} from '@/api/config'
export default {
    data(){
        return {
            time:0,
            flag:false,
            appointFlag:false,
            tabContents:['聊天','详情','榜单'],
            currentTabsIndex:0,
            liveTitle:'中国网正在上演',
            liveDetailsData:{},
            playerOptions:{},
            countDownState:false, //倒计时状态
            payTitle:'付费预约',
            inviteFlag:false,
            payF:false,//是否需要付费
            payState:false,//是否已支付 ，true为已支付，则不显示底部付费栏
            chatFlag:false,//是否展示聊天室
            headimgstate:true,//是否显示图片，false为不显示
            player:null,//直播初始化
            weixinFlag:false, //顶部标题
            code:'',
            introudeData:[],
            showVideoFlag:false,//是否显示视频
            showLCFlag:false,//是否显示底部邀请，付费
            loginState:'loginF'
        }
    },
    components:{ Countdown, Login, Title, Chat, Details, List},
    methods:{
        // 直播倒计时
        limiteTime(time,id) {
            const nowTime = new Date().getTime()
            let diffTime = time - nowTime
            let timer = null
            timer = setInterval(() => {
            diffTime -= 1000
            if(diffTime > 0) {
                //d天，h小时,m分,s秒
                var d = Math.floor(diffTime/3600000/24), h = Math.floor(diffTime/3600000), m = Math.floor((diffTime - (h*3600000))/60000), 
                s = Math.floor((diffTime - (h*3600000) - (m*60000))/1000)
                //doubleCountHandle
                if(h > 24 || h == 24) {
                    h = h%24;
                }
                if(document.getElementById(`cdd${id}`)) {
                document.getElementById(`cdd${id}`).innerText = doubleCountHandle(d)
                }
                if(document.getElementById(`cdh${id}`)) {
                document.getElementById(`cdh${id}`).innerText = doubleCountHandle(h)
                }
                if(document.getElementById(`cdm${id}`)) {
                document.getElementById(`cdm${id}`).innerText = doubleCountHandle(m)
                }
                if(document.getElementById(`cds${id}`)) {
                document.getElementById(`cds${id}`).innerText = doubleCountHandle(s)
                }
            } else {
                clearInterval(timer)
                timer = null
                return false
            }
            }, 1000)
        },
        // 是否已预约
        appointMessage() {
            this.$ajax.appointF({
                user_id:getLStorage('userid'),
                live_id:this.$route.params.liveId
            }).then(res =>{
                // 1 已预约 0 未预约
                if(res.data == '1' && this.liveDetailsData.live_status !== 5) {
                    this.appointFlag = true;
                    this.headimgstate = false;
                    this.chatFlag = true;
                    this.showVideoFlag = true;
                    this.showLCFlag = false;
                    console.log(1)
                }else {
                    this.appointFlag = false;
                    this.headimgstate = true;
                    this.chatFlag = false;
                    this.showVideoFlag = false;
                    this.showLCFlag = true;
                     console.log(2)
                }
                
            })
        },
        // 直播预约
        liveAppointment() {
            var params = {
                user_id:getLStorage('userid'),
                live_id:this.$route.params.liveId,
                mobile:getLStorage('mobile')
            }
            this.$ajax.liveAppoint(params).then(res =>{
                // console.log(res)
                if(res.data) {
                    this.chatFlag = true
                    this.headimgstate = false
                    this.showLCFlag = false
                    this.showVideoFlag = true
                    this.$toast('预约已成功 直播前将会短信提醒您')
                }
            })
        },
        //是否付费
        payLiveState() {
            var params = {
                user_id:getLStorage('userid'),
                live_id:this.$route.params.liveId,
                receive_user_id:this.liveDetailsData.user_id
            }
            this.$ajax.livePay(params).then(res =>{
                // console.log(res)
                //1代表已经付费，headimgstate不显示图片显示为录像
                if(res.data == '1') {
                    if (this.liveDetailsData.live_status == 1 || this.liveDetailsData.live_status == 2) {
                        this.payTitle = '付费直播'
                    }else {
                        this.payTitle = '付费预约'
                    }
                    this.payState = true
                    this.headimgstate = false
                    this.showVideoFlag = true
                    this.showLCFlag = false
                }else {
                    //未付费情况下，是否是免费且已经预约，
                    // if(this.chatFlag) {
                    //     this.headimgstate = false
                    // }else {
                    //     this.headimgstate = true
                    // }
                    if(this.liveDetailsData.live_permit == 2) {
                        this.headimgstate = true
                        this.payState = false
                        this.showVideoFlag = false
                        this.showLCFlag = true
                    }
                }
                // if(res.code = 200) {
                //     this.appointMessage();//是否已预约
                // }
            })
        },
        // 支付
        pay(){
            // 是否已绑定手机号
            if(getLStorage('userid')) {
                this.flag = false
                this.loginState = 'loginF'
                this.appointMessage()
                document.getElementsByTagName('body')[0].style.overflow= 'visible' 
            }else {
                this.flag = true;
                this.loginState = 'changF'
                document.getElementsByTagName('body')[0].style.overflow= 'hidden' //处理弹框页面滚动
            }
            // 未付费
            if(!this.payState && getLStorage('userid')) {
                // 是否需要付费
                if(this.payF) {
                    this.payTitle = '付费预约'
                    // 判断是微信支付还是h5支付
                    if(is_weixn()) {
                        console.log('wx支付')
                        this.getPayData()
                    }else {
                        console.log('h5支付')
                        this.payH()
                    }
                }else {
                    this.liveAppointment()
                }
            }
        },
        // 微信获取用户的相关支付信息以及支付
        getPayData() {
            // var params = {
            //     userId:'97786388644102796',
            //     open_id:'oAhS8wTxh7eWeH7VRO22PPI5nrVk',
            //     live_id:'817433040751051256',
            //     video_id:this.liveDetailsData.id,
            //     receive_user_id:1,
            //     type:1,
            //     money:0.01,
            //     source:2
            // }
            var params = {
                userId:getLStorage('userid'),
                open_id:getLStorage('wxUserOpenid'),
                // open_id:'oAhS8wTxh7eWeH7VRO22PPI5nrVk',
                live_id:this.$route.params.liveId,
                video_id:this.liveDetailsData.id,
                receive_user_id:1,
                type:1,
                money:this.liveDetailsData.view_pass,
                source:2
            }
            console.log(params)
            this.$ajax.payStart(params).then(res =>{
                console.log("微信支付：------" + JSON.stringify(res))
                console.log('信息阐述-：--------' + res.data)
                wx.config({
                    debug: true, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                    appId: res.data.appId, // 必填，公众号的唯一标识
                    timestamp: res.data.timeStamp, // 必填，生成签名的时间戳
                    nonceStr: res.data.nonceStr, // 必填，生成签名的随机串
                    signature: res.data.paySign,// 必填，签名，见附录1
                    jsApiList: [
                        'chooseWXPay',
                    ] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
                });
                    wx.chooseWXPay({
                    timestamp: res.data.timeStamp, // 支付签名时间戳，注意微信jssdk中的所有使用timestamp字段均为小写。但最新版的支付后台生成签名使用的timeStamp字段名需大写其中的S字符
                    nonceStr: res.data.nonceStr, // 支付签名随机串，不长于 32 位
                    package: res.data.packageStr, // 统一支付接口返回的prepay_id参数值，提交格式如：prepay_id=\*\*\*）
                    signType: res.data.signType, // 签名方式，默认为'SHA1'，使用新版支付需传入'MD5'
                    paySign: res.data.paySign, // 支付签名
                    success: function (res) {
                    // 支付成功后的回调函数
                    // console.log('支付成功：-----' + res)
                    }
                });
            })

        },
        // h5支付
         payH() {
            var params = {
                userId:getLStorage('userid'),
                live_id:this.$route.params.liveId,
                video_id:this.liveDetailsData.id,
                receive_user_id:1,
                type:2,
                money:this.liveDetailsData.view_pass,
                source:2
            }
            // console.log('h5 params:' + params + JSON.stringify(params))
            this.$ajax.payStart(params).then(res =>{
                // console.log("h5支付1：" + res,res.data)
                // console.log("h5支付2：" + JSON.stringify(res))
                window.location.href = res.data.mwebUrl
            })
        },
        // 聊天室tab切换
        selectTabs(index){
            this.currentTabsIndex = index;
        },
        // 直播间详情数据
        getLiveDetails() {
             if(is_weixn() || is_QQ()) {
                this.weixinFlag = true
            }
            this.$ajax.liveDetails({id:this.$route.params.liveId}).then(res =>{
                console.log(res)
                this.liveDetailsData = res.data;
                this.introudeData = JSON.parse(res.data.live_text_imgs)

                var nowTime = (new Date()).getTime();
                if(res.data.begin_time > nowTime){
                    this.countDownState = true;
                }
                if(res.code == 200) {
                    this.payLiveState();//是否付费及预约
                    // 是否付费，0：公开 1：私密 2：付费 3: 虚拟门票 4：白名单（live_permit）
                    // live_permit观看权限 0：公开（免费） 2：付费
                    if(res.data.live_permit == 0) {
                        // 绑定手机号
                        this.payTitle = '预告提醒'
                        this.payF = false
                        // 用户是否已登录
                        if(getLStorage('userid')){
                            this.appointMessage();//是否已预约
                        }else {
                            this.showLCFlag = true
                            this.showVideoFlag = false
                            this.headimgstate = true

                        }
                    }else if (res.data.live_permit == 2) {
                        this.payF = true
                        if(res.data.live_status == 1 || res.data.live_status == 2) {
                            this.payTitle = '付费直播'
                        }else {
                            this.payTitle = '付费预约'
                        }
                        if(getLStorage('userid')) {
                            this.appointMessage();//是否已预约
                        }
                    }
                }
            })
        },
         // 邀请
        invite() {
         this.inviteFlag = true;             
        },
        // 关闭邀请、送礼
        closeInvite() {
            this.inviteFlag = false;
            this.giftFlag = false;
        },
        // 直播视频
        playVideo(src, el) {
        var swfPlayer = new this.SWFPlayer("container", el, "520", "360", "12312.jpg");
        swfPlayer.reload(src);
        },
        SWFPlayer(_parent_id, _player_id, _width, _height, _poster) {
            var parent_id = _parent_id;
            var player_id = _player_id;
            var width = _width;
            var height = _height;
            var poster = _poster;
            var that = this;

            function createPlayer(src) {
                var swfVersionStr = "11.1.0";
                var xiSwfUrlStr = "../../../static/media/expressInstall.swf";

                var flashvars = {
                    src: src,
                    autoPlay: "true",
                    verbose: "true",
    //                volume: "0",
                    controlBarAutoHide: "true",
                    controlBarPosition: "bottom",
                    poster: poster,
                    plugin_hls:  "../../../static/media/HLSDynamicPlugin.swf",
                    VolumeMenuButton: "../../../static/media/HLSDynamicPlugin.swf",
                    javascriptCallbackFunction: "onJavaScriptBridgeCreated"
                };
                flashvars.src = src;
                flashvars.autoPlay = "true";

                var params = {
                    allowFullScreen: "true",
                };

                var attributes = {};
                attributes.mode = "transparent";
                attributes.id = player_id;
                attributes.name = player_id;
                //attributes.align = "middle";

                swfobject.embedSWF("../../../static/media/StrobeMediaPlayback.swf", player_id, width, height, swfVersionStr, xiSwfUrlStr, flashvars, params, attributes);
    //            swfobject.createCSS(".container", "display:block;text-align:left;background-color: #3a9425;"); //背景颜色控制
            };

            this.reload = function (src) {
                createPlayer(src);
            };
        },
        onCurrentTimeChange(time, playerId) {
            document.getElementById("currentTime").innerHTML = time;
        },
        onDurationChange(time, playerId) {
            document.getElementById("duration").innerHTML = time;
            console.log('time :: '+time)
        },
        onJavaScriptBridgeCreated(playerId){
            if (this.player == null) {
                this.player = document.getElementById("video-player");

                // Add event listeners that will update the
                this.player.addEventListener("currentTimeChange", "onCurrentTimeChange");
                this.player.addEventListener("durationChange", "onDurationChange");

                this.player.addEventListener("complete", "completeFunc");
            }
        },
        onComplete() {
            console.log('Complete111111!')
        },
        start() {
        var src1 = "rtmp://live.hkstv.hk.lxdns.com/live/hks";
        var src2 = " ";
            var el1 = "video-player";
            this.playVideo(src1, el1);
        }
    },
    mounted(){
        this.time = (new Date()).getTime()
        eventVue.$on('cancel', val => {
            // 点击遮罩层时的处理
            this.flag = val
            this.loginState = 'loginF'
            document.getElementsByTagName('body')[0].style.overflow= 'visible' 
        })
        this.getLiveDetails()
        // this.start()
        // 进入直播间自动播放直播
        var getVideoNode = document.getElementById('example_video_1')
        if(getVideoNode) {
            getVideoNode.play()
        }
    }
}
</script>
<style lang="scss">
.live {
    video {
        width: 100%;
    }
    #video-player {
        height: 18.1rem;
    }
    .play-live {
        position: relative;
        img {
            width: 100%;
            height: 21.1rem;
        }
        .live-end {
            width: 100%;
            height: 5rem;
            line-height: 5rem;
            background:rgba(45,46,53,0.6);
            text-align: center;
            font-size: 1.7rem;
            color: #fff;
            position: absolute;
            bottom: 0;
            left: 0;
        }
    }
    .top-live {
        display: flex;
        justify-content: space-between;
        height: 4.4rem;
        align-items: center;
        .logo {
            display: inline-block;
            width: 9rem;
            height: 2.5rem;
            background: url('images/logo.png') no-repeat;
            background-size: 9rem 2.5rem;
            margin-left: 1.5rem;
        }
        .home-personal {
            .personal-center,.home {
                display: inline-block;
                height: 2.7rem;
                width: 7rem;
                line-height: 2.7rem;
                color: #4A4A4A;
                border: 1px solid #979797;
                text-align: center;
                font-size: 1.2rem;
                border-radius: 1.6rem;
                margin-right: 1rem;
                &.goto {
                    color: #FF6633;
                    border-color: #FF6633;
                }
            }
        }
    }
    #myvideo {
        object-fit:fill;
        width: 100%;
        height: 21.1rem;
        display: block;
    }
    .livehomestate {
        // 预约
        .start-time {
            width: 100%;
            height: 5rem;
            background: #2D2E35;
            display: flex;
            justify-content: space-between;
            align-items:center;
            .start-title {
                color: #9B9B9B;
                padding-left: 1.5rem;
                font-size: 1.4rem;
            }
            .time {
                padding-right: 1.5rem;
                color: #fff;
                .countdown-box {
                    color: #fff;
                    font-size: 3rem;
                }
                sub {
                    font-size: 1.1rem;
                    color: #9B9B9B;
                    position: relative;
                    top: -0.4rem;
                }
            }
        }
        .details {
            padding-bottom: 4.8rem;
            .title {
                border-bottom: 1px solid #f2f2f2;
                .live-title {
                    font-size: 1.7rem;
                    padding: 0.6rem 5.6rem 0.6rem 1.5rem;
                    font-family:PingFangSC-Medium;
                    font-weight: bold;
                    color: #333333;
                    line-height: 2.5rem;
                }
                .start-time-title {
                    font-size: 1.3rem;
                    color: #999;
                    padding: 0.6rem 0 0.6rem 1.5rem;
                    &.end {
                        padding-bottom: 2rem;
                    }
                }
                .money {
                    padding: 0 0 1.5rem 1.5rem;
                    span {
                        color: #FF6634;
                        &.no-money {
                            color: #34A853;
                            font-size: 1.2rem;
                        }
                    }
                }
            }
            .introduction {
                h5 {
                    font-size: 1.6rem;
                    color: #333;
                    padding: 1.5rem;
                    line-height: 2.3rem;
                }
                .int-img {
                    img {
                        width: 100%;
                        height: 21rem;
                        padding: 0 3%;
                    }
                    p {
                        font-size:1.4rem;
                        line-height: 2.5rem;
                    }
                }
                p {
                    font-size: 1.4rem;
                    color: #333;
                    line-height: 2.5rem;
                    padding: 0 1.5rem;
                }
                .no-introduct {
                   display: flex;
                   justify-content: center;
                }
            }
        }
            .bottom-invitation-pay {
                width: 100%;
                height: 4.8rem;
                position: fixed;
                bottom: 0;
                left: 0;
                display: flex;
                color: #fff;
                text-align: center;
                .invitation {
                    flex: 1;
                    background: #576AF4;
                    line-height: 4.8rem;
                }
                .pay {
                    flex: 2;
                    background: #FF6633;
                    line-height: 4.8rem;
                }
                // .payh {
                //     background: yellow;
                //     color: #000;
                //     flex: 2;
                // }
            }
        .mask {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,.5);
            z-index: 1;
        }
    }
    // 回放及直播
    .livehome-wrapper {
        .livehome {
            display: flex;
            justify-content: center;
            align-items:center;
            height: 4.4rem;
            .chat-detail-se {
                .tabs-item {
                    padding: 1.2rem 2.8rem;
                    font-size: 1.3rem;
                    color:#111;
                    display: flex;
                    align-items: center;
                    &.active {
                        color: #FF6633;
                    }
                    }
            }
        }
    }
    // 邀请
.invite-enter-active{
	/*从下到上*/
	animation:slideTop .4s;
}


.invite-leave-active{

	/*从上到下*/
	animation:slideBottom .4s;
}


@keyframes slideTop{

	0%{
		transform: translate(0,100%);
	}

	100%{
		transform: translate(0,0);
	}
}

@keyframes slideBottom{

	0%{
		transform: translate(0,0);
	}

	100%{
		transform: translate(0,100%);
	}
}
.live-invite {
    height: 14.8rem;
    width: 100%;
    background: #fff;
    position: fixed;
    bottom: 0;
    left: 0;
    z-index: 15;
    .card {
        width: 100%;
        height: 10.5rem;
        border-bottom: 1px solid #E3E3E7;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        span {
            color: #909090;
            margin-top: 0.3rem;
        }
    }
    .cancel {
        width: 100%;
        height: 4.1rem;
        line-height: 4.1rem;
        text-align: center;
    }
}
.mask {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0, .5);
    z-index: 1;
}
}
#svideo.vjs-custom-skin .video-js.vjs-paused .vjs-big-play-button {
    width: 52px !important;
    height: 52px !important;
    border-radius: 50%;
    margin-left: -26px;
    line-height: 1.4em !important;
  }
</style>


