import Vue from 'vue'
import Router from 'vue-router'
import * as utils from '@/common/utils'
import fetch from '@/api/api'
import { getQueryString, getLStorage, setLStorage } from '@/api/config'
import { is_weixn } from '@/utils/utils'

/*大厅*/
import Hall from '@/views/hall/Index'
import Search from '@/views/hall/Search'
import Live from '@/views/hall/Live'
import InviteCard from '@/views/hall/live/Invite' //邀请卡片页面

/*视频*/
import Video from '@/views/video/Index'
import VideoDetails from '@/views/video/Details'

/*预约*/
import Appointment from '@/views/appointment/Index'

/*个人中心*/
import Personal from '@/views/personal/Index'
import Feedback from '@/views/personal/Feedback'
import Newphone from '@/views/personal/Newphone'
import Login from '@/views/personal/Login' //登陆

/*OTT反馈专用页面*/
import FeedbackOTT from '@/views/FeedbackOTT'

Vue.use(Router)

const router = new Router({
    // mode: 'history',
    routes: [{
            path: '/',
            name: 'Hall',
            component: Hall,
            meta: {
                title: '中国网正在上演',
                navStatus: true
            }
        },
        {
            path: '/search',
            name: 'Search',
            component: Search,
            meta: {
                title: '中国网正在上演'
            }
        },
        {
            path: '/live/:liveId',
            name: 'Live',
            component: Live,
            meta: {
                title: '中国网正在上演'
            }
        },
        {
            path: '/invite',
            name: 'Invite',
            component: InviteCard,
            meta: {
                title: '中国网正在上演'
            }
        },
        {
            path: '/appointment',
            name: 'Appointment',
            component: Appointment,
            meta: {
                title: '中国网正在上演',
                navStatus: true
            }
        },
        {
            path: '/personal',
            name: 'Personal',
            component: Personal,
            meta: {
                navStatus: true
            }
        },
        {
            path: '/login',
            name: 'Login',
            component: Login
        },
        {
            path: '/newphone',
            name: 'Newphone',
            component: Newphone,
        },
        {
            path: '/feedback',
            name: 'Feedback',
            component: Feedback,
        },
        {
            path: '/feedbackOTT',
            name: 'FeedbackOTT',
            component: FeedbackOTT,
        },
        {
            path: '/video',
            name: 'Video',
            component: Video,
            meta: {
                title: '中国网正在上演',
                navStatus: true
            }
        },

        {
            path: '/video/details/:videoId',
            name: 'VideoDetails',
            component: VideoDetails
        }
    ]
})

router.beforeEach((to, from, next) => {
    // 未登陆时跳转操作
    if ((to.name === 'Personal' || to.name === 'Appointment') && !getLStorage("userid")) {
        router.push({ path: '/login' })
    }
    var url = window.location.href;

    // 先判断是否从微信进入，后判断未拿到code值时调用
    if (is_weixn()) {
        if (url.indexOf('code') == -1 && !getLStorage('wxUserOpenid')) {
            fetch.wxStart({
                redirect_uri: url
            }).then(res => {
                console.log("res值:" + JSON.stringify(res))
                console.log("res.data:" + res.data)
                window.location.href = res.data;
            })
        } else {
            //获取用户信息
            fetch.getUerInfo({
                code: getQueryString('code')
            }).then(res => {
                console.log("用户信息：" + res.data)
                console.log("用户信息：" + JSON.stringify(res))
                setLStorage('code', getQueryString('code'));
                setLStorage('wxUserInfo', JSON.stringify(res.data))
                setLStorage('wxUserOpenid', JSON.stringify(res.data.openid))
            })
        }
    }
    // 设置各个路由的标题
    utils.setTitle(to.meta.title || '')
    next()
})

export default router