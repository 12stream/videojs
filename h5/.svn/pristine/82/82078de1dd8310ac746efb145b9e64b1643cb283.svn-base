<template>
    <div class="live" id="paya">
        <div class="topv">
            <!-- <a :href="payLink" v-if="payLink !==''"><span id="payh">支付</span></a> -->
            <!-- <Title :showtitle='liveTitle' v-if="!weixinFlag"></Title> -->
            <div class="top-live">
                <span class="logo"></span>
                <div class="home-personal">
                    <span class="personal-center" @click="$router.push({path:'/personal'})">个人中心</span>
                    <span class="home goto" @click="$router.push({path:'/'})">返回首页</span>
                    <div class="views-live" v-if="showVideoFlag && !appointVideo && liveDetailsData.live_statu == 1">
                        <i></i><span>直播 {{viewsLive}}人观看</span>
                    </div>
                    <!-- 详情页为直播时显示观看人数 -->
                    <div class="views-live" v-if="detailsLiveF">
                        <i></i><span>直播 {{liveDetailsData.play_count}}人观看</span>
                    </div>
                    <div class="views-live appoint-see" v-if="!appointVideo && liveDetailsData.live_statu == 2 && !appointRet">
                    <span>{{liveDetailsData.play_count}}人看过</span>
                    </div>
                </div>
            </div>
            <!-- 直播状态 0：直播创建 预告 1：正在直播 2：直播回放 5：直播结束，无录像 -->
            <!-- 直播结束展示图片 -->
            <div class="play-live" v-if="headimgstate  && ((liveDetailsData.live_before_type == 0 || liveDetailsData.live_statu == 5) || (againSee && liveDetailsData.live_before_type == 0))">
                <img :src="liveDetailsData.live_cover_url">
                <!-- 直播已结束 -->
                <div class="live-end" v-if="liveDetailsData.live_statu == 5">
                    直播已结束
                </div>
            </div>  
            <!-- 原生播放后台返回的拉流地址播放 -->
            <!-- <div class="play-live" v-show="showVideoFlag">
                <video id="example_video_1" class="video-js" webkit-playsinline="" playsinline="" x5-playsinline="" x-webkit-airplay="allow"
                    width="100%" height="100%" :src="liveDetailsData.play_m3u8_url" preload="true" :poster="liveDetailsData.live_cover_url">
                </video>
                <div class="views-live">
                    <i></i><span>直播 {{liveDetailsData.watch_num}}人观看</span>
                </div>
            </div> -->
            <img :src="liveDetailsData.live_cover_url" v-if="imgL" id="img-login">
            <!-- <video-player id="appointvideo" class="vjs-custom-skin" :options="playerOptions" v-show="appointVideo">
            </video-player> -->
            <video controls="controls" id="appointvideo" class="vjs-custom-skin" :src="liveDetailsData.live_before_url" :poster="liveDetailsData.live_cover_url" v-show="appointVideo">
            </video>
            <!-- android手机端播放直播视频 -->
            <video controls="controls" id="example_video_1" class="video-js play-live" webkit-playsinline="true" playsinline="true" x5-playsinline="" x-webkit-airplay="allow"
                    width="100%" height="100%" :src="liveDetailsData.play_m3u8_url" preload="true" :poster="liveDetailsData.live_cover_url" @play="onPlayerPlay($event)" @pause="onPlayerPause($event)" v-show="showVideoFlag && !appointVideo && liveDetailsData.live_statu !== 2 ">
            </video>
            <video controls="controls" id="example_video_1" class="video-js play-live" webkit-playsinline="true" playsinline="true" x5-playsinline="" x-webkit-airplay="allow"
                    width="100%" height="100%" :src="liveDetailsData.new_play_url" preload="true" :poster="liveDetailsData.live_cover_url" @play="onPlayerPlay($event)" @pause="onPlayerPause($event)" v-show="showVideoFlag && !appointVideo && liveDetailsData.live_statu == 2">
            </video>
            <!-- ios播放直播视频 -->
            <!-- <video  controls="controls" id="example_video_1" class="video-js play-live" webkit-playsinline="true" playsinline="true" x5-playsinline="" x-webkit-airplay="allow" width="100%" height="100%" preload="true" :poster="liveDetailsData.live_cover_url" v-show="showVideoFlag && !appointVideo && iosFlag">
                <source :src="liveDetailsData.play_m3u8_url" />
                你的浏览器不支持H5播放器    
            </video> -->
            <div class="start-time" v-if="lF && chatFlag && (liveDetailsData.live_statu !== 1) && ((cdFlag && !headimgstate) || liveDetailsData.live_before_type == 0)">
                <div class="start-title">离直播开始还有</div>
                <div class="time">
                    <span class="countdown-box" :id="`cdd${liveDetailsData.id}`" v-cloak>00</span> <sub>天</sub> <span class="countdown-box" :id="`cdh${liveDetailsData.id}`" v-cloak>00</span> <sub>时</sub> <span class="countdown-box" :id="`cdm${liveDetailsData.id}`" v-cloak>00</span> <sub>分</sub> <span class="countdown-box" :id="`cds${liveDetailsData.id}`" v-cloak>00</span><sub>秒</sub>
                    {{limiteTime(liveDetailsData.begin_time, liveDetailsData.id)}} 
                </div>
            </div>
        </div>
            <!-- 直播详情 -->
            <div class="livehomestate" v-if="headimgstate && show">
                <!-- 未到直播时倒计时 -->
                <!-- <div class="start-time" v-if="countDownState && liveDetailsData.live_statu !== 5"> -->
                <div class="start-time" v-if="liveDetailsData.live_statu !== 5 && (liveDetailsData.live_statu !== 1 && liveDetailsData.live_statu !== 2)">
                    <div class="start-title">离直播开始还有</div>
                    <div class="time">
                        <span class="countdown-box" :id="`cdd${liveDetailsData.id}`" v-cloak>00</span> <sub>天</sub> <span class="countdown-box" :id="`cdh${liveDetailsData.id}`" v-cloak>00</span> <sub>时</sub> <span class="countdown-box" :id="`cdm${liveDetailsData.id}`" v-cloak>00</span> <sub>分</sub> <span class="countdown-box" :id="`cds${liveDetailsData.id}`" v-cloak>00</span><sub>秒</sub>
                        {{limiteTime(liveDetailsData.begin_time, liveDetailsData.id)}} 
                    </div>
                </div>
                <div class="details">
                    <div class="title">
                        <div class="live-title">{{liveDetailsData.live_name}}</div>
                        <div :class="liveDetailsData.live_statu == 5 ? 'start-time-title end' : 'start-time-title'">开始时间：<Countdown :time='liveDetailsData.begin_time' :timeflag="true"></Countdown></div>
                        <div class="money" v-if="liveDetailsData.live_permit == 0 && liveDetailsData.live_statu !== 5">
                            <span class="no-money">免费</span>
                        </div>
                        <div class="money" v-else-if="liveDetailsData.live_permit !== 0">
                            <img src="./images/icon_fufei.png">
                            <span>￥{{liveDetailsData.view_pass}}</span>
                        </div>
                    </div>
                    <div :class="showLCFlag ? 'introduction disance' : 'introduction'">
                        <h5>简介</h5>
                        <div v-if="introudeData.length !== 0" v-for="(item,i) in introudeData" :key="i" class="int-img">
                            <img :src="item.img_url" v-if="item.img_url"> 
                            <p v-else>{{item.img_text}}</p>
                        </div>
                        <div v-if="introudeData.length == 0" class="no-introduct">
                            <img src="./images/no-introuduce.png">
                        </div>
                        <p v-if="introudeData.length == 0">暂无简介哦~</p>
                    </div>
                </div>
                <!-- 底部预约和邀请按钮 -->
                <!-- <div id="bottom-live" class="bottom-invitation-pay" v-if="showLCFlag">
                    <span class="invitation" @click="invite">邀请</span>
                    <span class="pay" @click="pay">{{payTitle}}</span>
                </div> -->
                <Login v-if="flag" :loginF="loginState"></Login>
                <div class="mask-live" v-if="flag"></div>
            </div>
            <!-- 直播间 -->
            <div class="livehome-wrapper" v-if="chatFlag">
                <div class="livehome">
                    <div class="chat-detail-se" v-for="(item,i) in tabContents" :key="i">
                    <div :class="currentTabsIndex == i ? 'tabs-item active' : 'tabs-item'" @click="selectTabs(i)">
                        <span>{{item}}</span>
                    </div>
                    </div>
                </div>
                <Chat :hf="headimgstate" :sw="show" :detail="liveDetailsData" :wxQQ='weixinFlag' :cdtime='countDownState' v-show="currentTabsIndex == 0" :ctime='cTime'></Chat>
                <Details :detail="liveDetailsData" :introu='introudeData' v-show="currentTabsIndex == 1"></Details>
                <List v-show="currentTabsIndex == 2"></List>
            </div>
            <!-- 邀请 -->
            <!-- <transition name="invite" v-if="inviteFlag">
                <div class="live-invite1">
                    <div class="card" @click="$router.push({path:`/invite/${liveDetailsData.id}`})">
                        <img src="./images/card.png">
                        <span>邀请卡</span>
                    </div>
                    <div class="cancel" @click="closeLiveInvite">取消</div>
                </div>
            </transition> -->
        <!-- <div class="mask-live" v-if="inviteFlag" @click="closeInvite"></div> -->

        <!-- 支付等待加载中 -->
        <Wait class="pay-wait" v-if="payWaitFlag"></Wait>
        <div class="mask-wait" v-if="payWF"></div>
        <Wait class="no" v-if="loadingFR"></Wait>
    </div>
</template>
<script>
import Countdown from '@/components/CountDown'
import Login from '@/components/LoginBox'
import Wait from '@/components/Wait'
import Title from '@/components/Title'
import Chat from './live/Chat'
import Details from './live/Details'
import List from './live/List'
import { doubleCountHandle, is_weixn, is_QQ } from '@/utils/utils.js'
import eventVue from '@/components/eventVue.js'
import {setLStorage, getLStorage, delLStorage, getCookie} from '@/api/config'
import {MD5} from '@/utils/utils'
export default {
    data(){
        return {
            time:0,
            flag:false,
            payLink:'',
            appointFlag:false,
            tabContents:['聊天','详情','榜单'],
            currentTabsIndex:0,
            liveTitle:'中国网正在上演',
            liveDetailsData:{},
            playerOptions:{},
            countDownState:false, //倒计时状态
            // payTitle:'付费预约',
            inviteFlag:false,
            payF:false,//是否需要付费
            payState:false,//是否已支付 ，true为已支付，则不显示底部付费栏
            chatFlag:false,//是否展示聊天室
            headimgstate:true,//是否显示图片，false为不显示
            player:null,//直播初始化
            weixinFlag:false, //顶部标题
            code:'',
            introudeData:[],
            showVideoFlag:false,//是否显示视频
            showLCFlag:false,//是否显示底部邀请，付费
            loginState:'loginF',
            appointVideo:false,//录播
            againSee:false,
            show:false,
            androidFlag:false,
            iosFlag:false,
            viewsLive:0,
            cTime:'chat',//判断是否显示倒计时，初始化为无
            appointRet:false,//观看
            cdFlag:true,
            lF:true,
            changeState:false,
            imgL:false,
            payWaitFlag:false, //支付等待
            payWF:false,//支付等待遮罩层
            detailsLiveF:false,
            loadingFR:true
        }
    },
    components:{ Countdown, Login, Title, Chat, Details, List, Wait},
    methods:{
        // 点击播放时
        onPlayerPlay(e) {
            console.log(e,1234)
            // alert(1)
            var mdfive = MD5()
            setLStorage('md5', mdfive)
            // console.log(mdfive)
            if(this.liveDetailsData.live_statu == 1) {
                var ps = 1
            }else {
                var ps = 2
            }
            if(this.liveDetailsData.live_permit == 2) {
                if(is_weixn()) {
                    if(getLStorage('thirdUserInfo')){
                        var tuiS = JSON.parse(getLStorage('thirdUserInfo'))
                        var thirUseridS = tuiS.id
                        if(tuiS.mobile){
                            var thirMobileS = tuiS.mobile
                        }
                    }
                    var params = {
                        user_id:thirUseridS,
                        client_user_info:thirMobileS || getLStorage('mobile'),
                        video_type:ps,
                        id:this.$route.params.liveId,
                        source_type:3,
                        group_id:mdfive
                    }
                }else {
                    if(getLStorage('mobileUserInfo')){
                        var mobileMes = JSON.parse(getLStorage('mobileUserInfo'))
                    }
                    var params = {
                        user_id:getLStorage('userid') || mobileMes.id,
                        client_user_info:getLStorage('mobile') || mobileMes.mobile,
                        video_type:ps,
                        id:this.$route.params.liveId,
                        source_type:2,
                        group_id:mdfive
                    }
                }
                this.$ajax.recodeVideoWatchStart(params).then(res =>{
                    console.log(res)
                })
            }
        },
        // 点击暂停播放时
        onPlayerPause(e) {
            // console.log(e,getLStorage('md5'))
            // alert(2)
            var params = {
                group_id:getLStorage('md5')
            }
            if(this.liveDetailsData.live_permit == 2 && (this.liveDetailsData.live_statu == 1 || this.liveDetailsData.live_statu == 2)) {
                this.$ajax.recodeVideoWatchEnd(params).then(res =>{
                    console.log(res)
                    if(res.code == '200') {
                        delLStorage('md5')
                    }
                })
            }
        },
        // // 关闭邀请卡
        // closeLiveInvite(){
        //     this.inviteFlag = false
        // },
        // 直播倒计时
        limiteTime(time,id) {
            const nowTime = new Date().getTime()
            let diffTime = time - nowTime
            let timer = null
            timer = setInterval(() => {
            diffTime -= 1000
            if(diffTime > 0) {
                //d天，h小时,m分,s秒 1天 = 1x24x60x60x1000
                var d = Math.floor(diffTime/3600000/24), h = Math.floor(diffTime/3600000), m = Math.floor((diffTime - (h*3600000))/60000), 
                s = Math.floor((diffTime - (h*3600000) - (m*60000))/1000)
                //doubleCountHandle
                if(h > 24 || h == 24) {
                    h = h%24;
                }
                if(document.getElementById(`cdd${id}`)) {
                    document.getElementById(`cdd${id}`).innerText = doubleCountHandle(d)
                }
                if(document.getElementById(`cdh${id}`)) {
                    document.getElementById(`cdh${id}`).innerText = doubleCountHandle(h)
                }
                if(document.getElementById(`cdm${id}`)) {
                    document.getElementById(`cdm${id}`).innerText = doubleCountHandle(m)
                }
                if(document.getElementById(`cds${id}`)) {
                document.getElementById(`cds${id}`).innerText = doubleCountHandle(s)
                }
            } else {
                clearInterval(timer)
                timer = null
                return false
            }
            }, 1000)
        },
        // 播放回放
        beforeLive() {
            this.playerOptions = {
                playbackRates: [0.7, 1.0, 1.5, 2.0], //播放速度
                autoplay: true, //如果true,浏览器准备好时开始回放。
                controls: true, //控制条
                preload: 'auto', //视频预加载
                muted: false, //默认情况下将会消除任何音频。
                loop: false, //导致视频一结束就重新开始。
                language: 'zh-CN',
                aspectRatio: '16:9', // 将播放器置于流畅模式，并在计算播放器的动态大小时使用该值。值应该代表一个比例 - 用冒号分隔的两个数字（例如"16:9"或"4:3"）
                fluid: true, // 当true时，Video.js player将拥有流体大小。换句话说，它将按比例缩放以适应其容器。
                sources: [{
                    type: 'application/x-mpegURL',
                    src: this.liveDetailsData.new_play_url
                }],
                poster: this.liveDetailsData.live_cover_url, //你的封面地址
                width: document.documentElement.clientWidth,
                notSupportedMessage: '此视频暂无法播放，请稍后再试' //允许覆盖Video.js无法播放媒体源时显示的默认信息。
            }
        },
        // 是否已预约
        appointMessage() {
            // 如果授权第三方获取到的信息由相关用户的手机号或者用户id，优先拿取
            if(getLStorage('thirdUserInfo')) {
                var tui = JSON.parse(getLStorage('thirdUserInfo'))
                var curUserid = tui.id
            }
            this.$ajax.appointF({
                user_id:curUserid || getLStorage('userid'),
                live_id:this.$route.params.liveId
            }).then(res =>{
                // 1 已预约 0 未预约
                if(res.data == '1' && this.liveDetailsData.live_statu !== 5) {
                    this.appointFlag = true;
                    this.headimgstate = false;
                    this.chatFlag = true;
                    this.showLCFlag = false;
                    eventVue.$emit('livebottom',false)
                    console.log(1)
                    if(this.liveDetailsData.live_statu == 1) {
                        this.showVideoFlag = true
                    }
                    if(this.showVideoFlag && this.liveDetailsData.live_statu == 1) {
                        document.getElementById('example_video_1').play()
                    }
                    // 预约免费
                    if(this.liveDetailsData.live_statu == 0 && this.liveDetailsData.live_permit == 0) {
                        console.log('预约免费')
                        this.showLCFlag = false
                        eventVue.$emit('livebottom',false)
                        // this.showVideoFlag = true
                        this.chatFlag = true
                        this.headimgstate = false
                        this.cdFlag = true
                        this.lF = true;
                        if (this.liveDetailsData.live_before_type == 1) {
                            this.appointVideo = true
                            //  this.$nextTick(() =>{
                            //     console.log(document.getElementById('appointvideo'))
                            //     var vNode = document.getElementById('appointvideo')
                            //     var vEle = vNode.getElementsByTagName('div')[0]
                            //     var vh = window.screen.height*0.33;
                            //     vNode.style.height = vh + 'px';
                            //     vEle.style.height = vh + 'px'
                            // })
                            this.playerOptions = {
                                playbackRates: [0.7, 1.0, 1.5, 2.0], //播放速度
                                autoplay: true, //如果true,浏览器准备好时开始回放。
                                controls: true, //控制条
                                preload: 'auto', //视频预加载
                                muted: false, //默认情况下将会消除任何音频。
                                loop: false, //导致视频一结束就重新开始。
                                language: 'zh-CN',
                                aspectRatio: '16:9', // 将播放器置于流畅模式，并在计算播放器的动态大小时使用该值。值应该代表一个比例 - 用冒号分隔的两个数字（例如"16:9"或"4:3"）
                                fluid: true, // 当true时，Video.js player将拥有流体大小。换句话说，它将按比例缩放以适应其容器。
                                sources: [{
                                    type: 'application/x-mpegURL',
                                    src: this.liveDetailsData.live_before_url
                                }],
                                poster: this.liveDetailsData.live_cover_url, //你的封面地址
                                width: document.documentElement.clientWidth,
                                notSupportedMessage: '此视频暂无法播放，请稍后再试' //允许覆盖Video.js无法播放媒体源时显示的默认信息。
                            }
                        }else {
                            this.appointVideo = false
                            this.headimgstate = true
                            if(this.liveDetailsData.live_before_type == 0) {
                                this.againSee = true
                                this.cdFlag = true
                            }
                            // this.show = true
                        }
                    }else if(this.liveDetailsData.live_statu == 0 && this.liveDetailsData.live_permit == 2) {
                        console.log('预约付费')
                        this.show = false
                        this.lF = true
                        this.cdFlag = true
                        if(this.liveDetailsData.live_before_type == 0) {
                            this.againSee = true
                            this.headimgstate = true
                        }else if(this.liveDetailsData.live_before_type == 1) {
                            this.appointVideo = true
                        }
                    }else if(this.liveDetailsData.live_statu == 2) {
                        console.log('回放')
                        this.showVideoFlag = true
                        this.appointVideo = false
                        this.headimgstate = false
                        this.appointRet = false
                        this.lF = false
                       this.beforeLive()
                    }   
                }else if(res.data == '1' && this.liveDetailsData.live_statu == 5){
                    console.log('已预约结束')
                    this.appointFlag = false;
                    this.headimgstate = true;
                    this.show = true;
                    this.chatFlag = false;
                    this.showLCFlag = false;
                    eventVue.$emit('livebottom',false)
                }else {
                    console.log('未预约')
                    this.appointFlag = false;
                    this.headimgstate = true;
                    this.show = true;
                    this.chatFlag = false;
                    this.showVideoFlag = false;
                    this.showLCFlag = true;
                    eventVue.$emit('livebottom',true)
                     console.log(2)
                     //付费直播
                    if(this.liveDetailsData.live_before_type == 1) {
                        this.appointVideo = true;
                    }
                    //  付费预约
                     if(this.liveDetailsData.live_permit == 2 && this.liveDetailsData.live_statu == 0) {
                          this.appointFlag = true;
                        //   this.againSee = false
                     }
                    //  直播免费时
                   if((this.liveDetailsData.live_statu == 1 || this.liveDetailsData.live_statu == 2) && this.liveDetailsData.live_permit == 0) {
                        this.showLCFlag = false
                        eventVue.$emit('livebottom',false)
                        this.showVideoFlag = true
                        this.chatFlag = true
                        this.headimgstate = false
                        this.lF = false
                        console.log('免费直播')
                        // document.getElementById('example_video_1').play()
                    }
                    // 回放收费
                    if(this.liveDetailsData.live_statu == 2 && this.liveDetailsData.live_permit == 2) {
                        if(this.liveDetailsData.live_before_type == 1) {
                            this.appointVideo = true
                            this.againSee = false
                            // this.appointRet = true
                        }else {
                            this.headimgstate = true
                            this.againSee = true
                            this.show = true
                            // this.appointRet = false
                        }
                        console.log('付费回放')
                    }
                    //  //  免费预约
                    // if(this.liveDetailsData.live_permit == 0 && this.liveDetailsData.live_statu == 0){
                    //     this.liveAppointment()
                    // }
                    // 回放免费
                    if(this.liveDetailsData.live_statu == 2 && this.liveDetailsData.live_permit == 0) {
                        this.showLCFlag = false
                        eventVue.$emit('livebottom',false)
                        this.showVideoFlag = true
                        this.chatFlag = true
                        this.headimgstate = false
                        this.appointVideo = false
                        this.lF = false
                        this.show = false
                        //  this.$nextTick(() =>{
                        //     console.log(document.getElementById('appointvideo'))
                        //     var vNode = document.getElementById('appointvideo')
                        //     vNode.getElementsByTagName('div')
                        //     var vh = window.screen.height*0.33;
                        //     vNode.style.height = vh + 'px';
                        // })
                        console.log('免费回放')
                        this.playerOptions = {
                                playbackRates: [0.7, 1.0, 1.5, 2.0], //播放速度
                                autoplay: true, //如果true,浏览器准备好时开始回放。
                                controls: true, //控制条
                                preload: 'auto', //视频预加载
                                muted: false, //默认情况下将会消除任何音频。
                                loop: false, //导致视频一结束就重新开始。
                                language: 'zh-CN',
                                aspectRatio: '16:9', // 将播放器置于流畅模式，并在计算播放器的动态大小时使用该值。值应该代表一个比例 - 用冒号分隔的两个数字（例如"16:9"或"4:3"）
                                fluid: true, // 当true时，Video.js player将拥有流体大小。换句话说，它将按比例缩放以适应其容器。
                                sources: [{
                                    type: 'application/x-mpegURL',
                                    // src: this.liveDetailsData.live_before_url
                                    src: this.liveDetailsData.new_play_url
                                }],
                                poster: this.liveDetailsData.live_cover_url, //你的封面地址
                                width: document.documentElement.clientWidth,
                                notSupportedMessage: '此视频暂无法播放，请稍后再试' //允许覆盖Video.js无法播放媒体源时显示的默认信息。
                        }
                    }
                    // 当直播已结束
                    if(this.liveDetailsData.live_statu == 5) {
                        this.showLCFlag = false
                        this.appointVideo = false
                        eventVue.$emit('livebottom',false)
                        this.showVideoFlag = false;
                        this.chatFlag = false
                        console.log('直播结束')
                    }
                    // 预约有预告视频时
                    if(this.liveDetailsData.live_statu == 0 && this.liveDetailsData.live_before_type == 1) {
                        this.appointVideo = true;
                        this.playerOptions = {
                                playbackRates: [0.7, 1.0, 1.5, 2.0], //播放速度
                                autoplay: true, //如果true,浏览器准备好时开始回放。
                                controls: true, //控制条
                                preload: 'auto', //视频预加载
                                muted: false, //默认情况下将会消除任何音频。
                                loop: false, //导致视频一结束就重新开始。
                                language: 'zh-CN',
                                aspectRatio: '16:9', // 将播放器置于流畅模式，并在计算播放器的动态大小时使用该值。值应该代表一个比例 - 用冒号分隔的两个数字（例如"16:9"或"4:3"）
                                fluid: true, // 当true时，Video.js player将拥有流体大小。换句话说，它将按比例缩放以适应其容器。
                                sources: [{
                                    type: 'application/x-mpegURL',
                                    src: this.liveDetailsData.live_before_url
                                }],
                                poster: this.liveDetailsData.live_cover_url, //你的封面地址
                                width: document.documentElement.clientWidth,
                                notSupportedMessage: '此视频暂无法播放，请稍后再试' //允许覆盖Video.js无法播放媒体源时显示的默认信息。
                        }
                    }else if(this.liveDetailsData.live_statu == 0 && this.liveDetailsData.live_before_type == 0){
                        this.headimgstate = true
                    }

                }
            })
        },
        // 直播预约，短信预约提醒，只对预约状态发送信息
        liveAppointment() {
            console.log(this.appointFlag)
            if(getLStorage('thirdUserInfo')){
                var thir = JSON.parse(getLStorage('thirdUserInfo'))
                var thirLUserid = thir.id
                if(thir.mobile){
                    var thirLMobile = thir.mobile
                }
            }
            var params = {
                user_id:getLStorage('userid') || thirLUserid,
                live_id:this.$route.params.liveId,
                mobile:getLStorage('mobile') || thirLMobile
            }
            this.$ajax.liveAppoint(params).then(res =>{
                // console.log(res)
                if(res.data) {
                    this.chatFlag = true
                    this.showLCFlag = false
                    eventVue.$emit('livebottom',false)
                    this.show = false
                    // 直播
                    if(this.liveDetailsData.live_statu == 1) {
                        this.payState = true
                        this.headimgstate = false
                        this.showVideoFlag = true
                        this.chatFlag = true
                        this.showLCFlag = false
                        eventVue.$emit('livebottom',false)
                        // document.getElementById('example_video_1').play()
                      // 预约成功后的预告,回放
                    }else if(this.liveDetailsData.live_statu == 0) {
                        this.cdFlag = true
                        this.payState = true
                        this.showLCFlag = false
                        this.chatFlag = true
                        this.lF = true
                        this.show = false
                        console.log('测试')
                        eventVue.$emit('livebottom',false)
                        if(this.liveDetailsData.live_before_type == 0) {
                            console.log('测试1')
                            this.headimgstate = true
                            this.showVideoFlag = false
                            this.appointVideo = false
                            this.againSee = true
                        }else{
                            console.log('测试2')
                            this.headimgstate = false
                            this.show = false
                            this.appointVideo = true
                            this.showVideoFlag = false
                            this.chatFlag = true
                        }
                    }else if(this.liveDetailsData.live_statu == 2) {
                        this.headimgstate = false
                        this.appointVideo = false
                        this.showVideoFlag = true
                        this.lF = false
                        this.cdFlag = false
                    }
                    console.log('直播预约')
                    if(this.liveDetailsData.live_statu == 0){
                        this.$toast('预约已成功 直播前将会短信提醒您')
                    }
                    // document.getElementById('example_video_1').play()
                }
            })
        },
        //是否付费
        payLiveState() {
            if(getLStorage('thirdUserInfo')) {
                var thirP = JSON.parse(getLStorage('thirdUserInfo'))
                var thirPUserid = thirP.id
            }
            var params = {
                user_id:getLStorage('userid') || thirPUserid,
                live_id:this.$route.params.liveId,
                receive_user_id:this.liveDetailsData.user_id
            }
            this.$ajax.livePay(params).then(res =>{
                console.log(JSON.stringify(res))
                //1代表已经付费，headimgstate不显示图片显示为录像
                if(res.data == '1') {
                    if(this.liveDetailsData.live_statu == 0){
                        this.liveAppointment()
                    }
                    // if (this.liveDetailsData.live_statu == 1 || this.liveDetailsData.live_statu == 2) {
                    //     this.payTitle = '付费观看'
                    // }else {
                    //     this.payTitle = '付费预约'
                    // }
                    if(this.liveDetailsData.live_statu == 1) {
                        this.payState = true
                        this.headimgstate = false
                        this.showVideoFlag = true
                        this.chatFlag = true
                        this.showLCFlag = false
                        eventVue.$emit('livebottom',false)
                        this.lF = false
                        // document.getElementById('example_video_1').play()
                    }else if(this.liveDetailsData.live_statu == 0) {
                        this.cdFlag = true
                        this.payState = true
                        this.showLCFlag = false
                        this.chatFlag = true
                        this.lF = true
                        this.show = false
                        eventVue.$emit('livebottom',false)
                        if(this.liveDetailsData.live_before_type == 0) {
                            this.headimgstate = true
                            this.showVideoFlag = false
                            this.appointVideo = false
                            this.againSee = true
                        }else {
                            this.headimgstate = false
                            this.appointVideo = true
                            this.showVideoFlag = false
                        }
                    }else if(this.liveDetailsData.live_statu == 2) {
                        this.appointVideo = true
                        this.chatFlag = true
                        this.lF = false
                        this.headimgstate = false
                    }
                    console.log('已付费')
                    
                }else {
                    //未付费情况下，是否是免费且已经预约，
                    // if(this.chatFlag) {
                    //     this.headimgstate = false
                    // }else {
                    //     this.headimgstate = true
                    // }
                    // live_before_type为0时为没有视频，展示图片，live_before_type为1时有点播视频
                    if(this.liveDetailsData.live_permit == 2 && this.liveDetailsData.live_statu !== 5) {
                        this.headimgstate = true
                        this.show = true
                        this.payState = false
                        this.showVideoFlag = false
                        this.chatFlag = false
                        this.showLCFlag = true
                        eventVue.$emit('livebottom',true)
                        this.againSee = true
                        if(this.liveDetailsData.live_statu == 1) {
                            if(this.liveDetailsData.live_before_type == 1) {
                                this.appointVideo = true
                            }
                            // detailsLiveF状态为详情直播时观看人数
                            if(!this.chatFlag) {
                                this.detailsLiveF = true
                            }else {
                                this.detailsLiveF = false
                            }
                        }
                        if(this.liveDetailsData.live_statu == 0 && this.liveDetailsData.live_before_type == 0) {
                            this.againSee = true
                            this.appointVideo = false
                        }else if(this.liveDetailsData.live_statu == 0 && this.liveDetailsData.live_before_type == 1) {
                            this.againSee = false
                            this.appointVideo = true
                        }
                        if(this.liveDetailsData.live_statu == 2 && this.liveDetailsData.live_before_type == 0) {
                            this.appointRet = true
                        }else if(this.liveDetailsData.live_statu == 2 && this.liveDetailsData.live_before_type == 1) {
                            this.appointVideo = true
                            this.appointRet = false
                        }
                        console.log('未付费需要付费且不是结束状态的情况')
                    }
                    
                }
                // if(res.code = 200) {
                //     this.appointMessage();//是否已预约
                // }
            })
        },
        // 支付
        pay(){
            // 是否已绑定手机号
            if(getLStorage('thirdUserInfo')) {
                var thirMessage = JSON.parse(getLStorage('thirdUserInfo'))
                if(thirMessage.mobile){
                    var thirMobile = JSON.parse(getLStorage('thirdUserInfo')).mobile.length
                }
            }
            // 用户是否已登录,此判断不能根据用户的id来做判断，微信端用户登录时有用户id,但却没有手机号
            if(getLStorage('mobile') || thirMobile == 11) {
                this.flag = false
                this.playerOptions = {}
                // this.appointMessage()
                 //  免费预约
                if(this.liveDetailsData.live_permit == 0 && this.liveDetailsData.live_statu == 0){
                    this.liveAppointment()
                }
                document.getElementsByTagName('body')[0].style.overflow= 'visible' 
            }else {
                console.log(this.showVideoFlag,!this.appointVideo,this.liveDetailsData.live_statu !== 2)
                this.flag = true;
                // 微信端登录，h5端更换手机号
                if(is_weixn()) {
                    this.loginState = 'changF'
                }else {
                    this.loginState = 'loginF'
                }
                var bSo = document.getElementsByTagName('body')[0]
                var hSo = document.getElementsByTagName('html')[0]
                hSo.style.overflow= 'hidden' //处理弹框页面滚动
                hSo.style.height="100%"
                bSo.style.overflow= 'hidden' //处理弹框页面滚动
                bSo.style.height="100%"
                this.changeState = true
                if(this.appointVideo) {
                    this.$nextTick(() => {
                        var vpNode = document.getElementById('appointvideo')
                        vpNode.style.display = 'none'
                        this.imgL = true
                    })
                }
            }
            // 未付费,是否调用支付，不能看用户的id是否有误，看用户是否绑定手机号
            console.log(!this.payState && getLStorage('userid'))
            console.log(JSON.stringify(thirMessage))
            if((getLStorage('mobile') || (getCookie('wxuserid') && thirMessage.mobile)) && this.liveDetailsData.live_permit == 2 && this.liveDetailsData.live_statu !== 5) {
                console.log(this.liveDetailsData.live_permit)
                alert(this.liveDetailsData.live_permi)
                alert(this.payF)
                // 是否需要付费
                if(this.payF && this.liveDetailsData.live_permit == 2) {
                    // this.payTitle = '付费预约'
                    eventVue.$emit('payTitle','付费预约')
                    // 判断是微信支付还是h5支付
                    if(is_weixn()) {
                        console.log('wx支付')
                        this.payWaitFlag = true
                        this.getPayData()
                    }else {
                        console.log('h5支付')
                        this.payWaitFlag = true
                        this.payWF = true
                        this.payH()
                    }
                }else {
                    console.log('免费调预约')
                    if(this.liveDetailsData.live_statu == 0){
                        this.liveAppointment()
                    }
                }
            }
        },
        // 微信获取用户的相关支付信息以及支付
        getPayData() {
            console.log("wxopenid:" + getCookie('wxUserOpenid'))
            console.log("wxuserinfo:" + getCookie('wxUserInfo'))
            console.log("wxuserinfo:" + getLStorage('thirdUserInfo'))
            if(getLStorage('thirdUserInfo')){
                var thirUserid = JSON.parse(getLStorage('thirdUserInfo')).id
            }else if(getCookie('wxuserid')) {
                var thirUserid = getCookie('wxuserid')
            }
            if(!getCookie('userid') || getCookie('userid') !=='undefined') {
                var getcid = ''
            }else{
                var getcid = getCookie('userid')
            }
            var params = {
                userId:thirUserid || getcid,
                open_id:getCookie('wxUserOpenid'),
                // open_id:'oAhS8wTxh7eWeH7VRO22PPI5nrVk',
                live_id:this.$route.params.liveId,
                video_id:this.liveDetailsData.id,
                receive_user_id:1,
                type:1,
                money:this.liveDetailsData.view_pass,
                source:2
            }
            console.log(params)
            this.$ajax.payStart(params).then(res =>{
                this.payWaitFlag = false
                console.log("微信支付：------" + JSON.stringify(res))
                console.log('信息阐述-：--------' +  JSON.stringify(res.data))
                wx.config({
                    debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                    appId: res.data.appId, // 必填，公众号的唯一标识
                    timestamp: res.data.timeStamp, // 必填，生成签名的时间戳
                    nonceStr: res.data.nonceStr, // 必填，生成签名的随机串
                    signature: res.data.paySign,// 必填，签名，见附录1
                    jsApiList: [
                        'chooseWXPay',
                    ] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
                });
                console.log('res.data.timeStamp:' + res.data.timeStamp,'res.data.nonceStr:' +res.data.nonceStr,'res.data.packageStr:' +res.data.packageStr, 'res.data.signType:' +res.data.signType,"res.data.paySign:" +res.data.paySign)
                    wx.chooseWXPay({
                        timestamp: res.data.timeStamp, // 支付签名时间戳，注意微信jssdk中的所有使用timestamp字段均为小写。但最新版的支付后台生成签名使用的timeStamp字段名需大写其中的S字符
                        nonceStr: res.data.nonceStr, // 支付签名随机串，不长于 32 位
                        package: res.data.packageStr, // 统一支付接口返回的prepay_id参数值，提交格式如：prepay_id=\*\*\*）
                        signType: res.data.signType, // 签名方式，默认为'SHA1'，使用新版支付需传入'MD5'
                        paySign: res.data.paySign, // 支付签名
                        success:  res => {
                        // 支付成功后的回调函数
                        console.log('支付成功：-----' + JSON.stringify(res))
                        if(this.liveDetailsData.live_statu == 0){
                            this.liveAppointment()
                        }
                            this.chatFlag = true
                            this.headimgstate = false
                            // 支付成功后各播放状态
                            // 直播中
                            if(this.liveDetailsData.live_statu == 1) {
                                this.lF = false
                                this.showVideoFlag = true
                                this.appointVideo = false
                                // 预约
                            }else if(this.liveDetailsData.live_statu == 0) { 
                                this.lF = true
                                // 无预告视频
                                if(this.liveDetailsData.live_before_type == 0) {
                                    this.headimgstate = true
                                    this.show = false
                                    this.againSee = true
                                    // 有预告视频
                                }else {
                                    this.show = false
                                    this.againSee = false
                                    this.appointVideo = true
                                }
                                // 回放
                            }else if(this.liveDetailsData.live_statu == 2){
                                this.showVideoFlag = true
                                this.appointVideo = false
                                this.lF = false
                                this.beforeLive()
                            }else {
                                // 不处于直播情况下
                                if (this.liveDetailsData.live_before_type !== null) {
                                    this.appointVideo = true
                                }else {
                                    this.appointVideo = false
                                    this.headimgstate = true
                                }
                            }
                        }
                    });
            })

        },
        // h5支付
         payH() {
            // var newP = window.open('about:blank')
            if(getLStorage('mobileUserInfo')) {
                var pHF = JSON.parse(getLStorage('mobileUserInfo'))
                var resUserid = pHF.id
            }
            var params = {
                userId:getLStorage('userid') || resUserid,
                live_id:this.liveDetailsData.id,
                video_id:this.liveDetailsData.id,
                receive_user_id:1,
                type:2,
                money:this.liveDetailsData.view_pass,
                source:2
            }
            // console.log('h5 params:' + params + JSON.stringify(params))
            // window.open('','_blank')
            this.$ajax.payStart(params).then(res =>{
                console.log("h5支付1：" + res,res.data)
                console.log("h5支付2：" + JSON.stringify(res))
                console.log("h5支付地址：" + res.data.mwebUrl)
                var curPUrl = window.location.href + '?payS=1';
                // newP.location.href = `${res.data.mwebUrl}&redirect_url=${curPUrl}?payS=1`
                // alert(`${res.data.mwebUrl}&redirect_url=${encodeURIComponent(curPUrl)}`)
                window.location.href = `${res.data.mwebUrl}&redirect_url=${encodeURIComponent(curPUrl)}`
                this.payWaitFlag = false
                this.payWF = false
            })
        },

        // 聊天室tab切换
        selectTabs(index){
            this.currentTabsIndex = index;
        },
        // 直播间详情数据
        getLiveDetails() {
            var url = window.location.href;
            // 若授权页为当前页面，则对当前页面进行重定向
            if(url.indexOf('code') > -1) {
                window.location.href = `${url.split('?code')[0]}#/${this.$router.params.liveId}`
            }
             if(is_weixn() || is_QQ()) {
                this.weixinFlag = true
            }
            this.payRS()
            this.$ajax.liveDetails({id:this.$route.params.liveId}).then(res =>{
                console.log(res)
                this.liveDetailsData = res.data;
                this.introudeData = JSON.parse(res.data.live_text_imgs)
                if(res.data.live_statu == 0) {
                    this.cTime = 'chat ctime'
                    this.cdFlag = false
                }
                var nowTime = (new Date()).getTime();
                if(res.data.live_statu == 5){
                    this.countDownState = true;
                    console.log('结束')
                    this.headimgstate = true
                    this.show = true
                    this.chatFlag = false
                    this.appointVideo = false
                    this.showVideoFlag = false
                }
                if(res.code == '200') {
                    this.loadingFR = false
                    // this.show = true
                    // 是否付费，0：公开 1：私密 2：付费 3: 虚拟门票 4：白名单（live_permit）
                    // live_permit观看权限 0：公开（免费） 2：付费
                    if(res.data.live_permit == 0) {
                        // 绑定手机号
                        // this.payTitle = '预告提醒'
                        eventVue.$emit('payTitle','预告提醒')
                        this.payF = false
                        // 用户是否已登录,此判断不能根据用户的id来做判断，微信端用户登录时有用户id,但却没有手机号
                        if(getLStorage('userid') || getCookie('wxuserid')){
                            if(this.liveDetailsData.live_permit == 0) {
                                this.appointMessage();//是否已预约
                            }
                            this.payLiveState();//是否付费及预约
                        }else {
                            this.showLCFlag = true
                            eventVue.$emit('livebottom',true)
                            this.showVideoFlag = false
                            this.chatFlag = false
                            this.headimgstate = true
                            this.show = true
                            this.lF = false
                            console.log('未登录且免费时')
                            // 直播已结束
                            if(this.liveDetailsData.live_permit == 2 && this.liveDetailsData.live_statu == 5) {
                                this.showLCFlag = false
                                eventVue.$emit('livebottom',false)
                                this.showVideoFlag = false;
                                this.chatFlag = false
                                console.log('直播已结束，未登录，需付费的情况')
                            }
                            // 免费直播
                            if(this.liveDetailsData.live_permit == 0 && this.liveDetailsData.live_statu == 1) {
                                this.showLCFlag = false
                                eventVue.$emit('livebottom',false)
                                this.showVideoFlag = true
                                this.chatFlag = true
                                this.headimgstate = false
                                console.log('免费直播')
                                // document.getElementById('example_video_1').play()
                            }
                            // 免费回放
                            if(this.liveDetailsData.live_permit == 0 && this.liveDetailsData.live_statu == 2) {
                                this.showLCFlag = false
                                eventVue.$emit('livebottom',false)
                                this.showVideoFlag = true
                                this.chatFlag = true
                                this.headimgstate = false
                                this.appointVideo = false
                                this.lF = false
                                this.beforeLive()
                            }
                            // 预告视频
                            if(this.liveDetailsData.live_statu == 0 && this.liveDetailsData.live_before_type == 1) {
                                this.appointVideo = true;
                                this.playerOptions = {
                                        playbackRates: [0.7, 1.0, 1.5, 2.0], //播放速度
                                        autoplay: true, //如果true,浏览器准备好时开始回放。
                                        controls: true, //控制条
                                        preload: 'auto', //视频预加载
                                        muted: false, //默认情况下将会消除任何音频。
                                        loop: false, //导致视频一结束就重新开始。
                                        language: 'zh-CN',
                                        aspectRatio: '16:9', // 将播放器置于流畅模式，并在计算播放器的动态大小时使用该值。值应该代表一个比例 - 用冒号分隔的两个数字（例如"16:9"或"4:3"）
                                        fluid: true, // 当true时，Video.js player将拥有流体大小。换句话说，它将按比例缩放以适应其容器。
                                        sources: [{
                                            type: 'application/x-mpegURL',
                                            src: this.liveDetailsData.live_before_url
                                        }],
                                        poster: this.liveDetailsData.live_cover_url, //你的封面地址
                                        width: document.documentElement.clientWidth,
                                        notSupportedMessage: '此视频暂无法播放，请稍后再试' //允许覆盖Video.js无法播放媒体源时显示的默认信息。
                                }
                                console.log('未登录预告视频')
                            }else if(this.liveDetailsData.live_statu == 0 && this.liveDetailsData.live_before_type == 0) {
                                this.cdFlag = false
                                this.againSee = true
                            }
                        }
                    }else if (res.data.live_permit == 2) {
                        if(res.data.live_statu == 1 || res.data.live_statu == 2) {
                            // this.payTitle = '付费观看'
                            eventVue.$emit('payTitle','付费观看')
                        }else {
                            // this.payTitle = '付费预约'
                            eventVue.$emit('payTitle','付费预约')
                        }
                        this.payF = true
                        if(getLStorage('userid') || getCookie('wxuserid')) {
                            if(this.liveDetailsData.live_permit == 0) {
                                this.appointMessage();//是否已预约
                            }
                            this.payLiveState();//是否付费及预约
                        }else {
                            this.headimgstate = true
                            this.show = true;
                            eventVue.$emit('livebottom',true)
                            //付费预约
                            if(res.data.live_statu == 0 && this.liveDetailsData.live_before_type == 1) {
                                this.appointVideo = true;
                                //付费直播
                            }else if(res.data.live_statu == 0 && res.data.live_before_type == 0){
                                this.againSee = true
                            }else if(res.data.live_statu == 1 && res.data.live_before_type == 1){
                                this.appointVideo = true
                            }else {
                                this.appointVideo = false;
                                this.headimgstate = true;
                            }
                            // 付费回放
                            if(res.data.live_statu == 2 && res.data.live_before_type == 1) {
                                this.headimgstate = true;
                                this.againSee = true
                                this.appointVideo = true
                            }else if(res.data.live_statu == 2 && res.data.live_before_type == 0) {
                                this.headimgstate = true;
                                this.againSee = true
                                this.appointRet = true
                            }
                            //付费结束
                            if(res.data.live_statu == 5) {
                                this.headimgstate = true;
                                this.show = true
                            }
                            console.log('付费情况')
                        }
                    }
                }
            })
        },
         // 邀请
        invite() {
         this.inviteFlag = true;             
        },
        // 关闭邀请、送礼
        closeInvite() {
            this.inviteFlag = false;
            this.giftFlag = false;
        },
        // h5支付状态
        payStatusR(){
            this.chatFlag = true
            if(this.liveDetailsData.live_statu == 1) {
                this.payState = true
                this.headimgstate = false
                this.showVideoFlag = true
                this.appointVideo = false
                this.showLCFlag = false
                eventVue.$emit('livebottom',false)
                this.show = false
                this.lF = false
                // document.getElementById('example_video_1').play()
            }else if(this.liveDetailsData.live_statu == 0) {
                this.payState = true
                this.headimgstate = true
                this.showVideoFlag = false
                this.showLCFlag = false
                this.againSee = true
                this.show = false
                this.lF = true
                if(this.liveDetailsData.live_before_type == 0){
                    this.appointVideo = false
                }else{
                    this.appointVideo = true
                }
            }else if(this.liveDetailsData.live_statu == 2) {
                this.payState = true
                this.showVideoFlag = true
                this.appointVideo = false
                this.headimgstate = false
                this.appointVideo = true
                this.lF = false
                this.show = false
            }
        },
         // 支付之后返回页面判断
        payRS() {
            var curUrl = window.location.href;
            // 判断是否是支付返回的链接地址
            if(curUrl.indexOf('payS') > -1) {
                 this.$msgpay({
                    cancel:'重新支付',
                    content:'请确认微信支付是否已完成',
                    confirm:'已完成支付',
                    className:'pay-custom'
                }).then((o)=>{
                    console.log(o)
                    console.log(JSON.stringify(o))
                    var params = {
                        user_id:getLStorage('userid'),
                        live_id:this.$route.params.liveId,
                        receive_user_id:this.liveDetailsData.user_id
                    }
                    this.$ajax.livePay(params).then(res =>{
                        console.log(JSON.stringify(res))
                        if(res.data == '1') {
                            this.$toast('支付成功!')
                            if(this.liveDetailsData.live_statu == 0){
                                this.liveAppointment()
                            }
                            // this.payLiveState()
                            this.payStatusR()
                        }else{
                           this.$msgpay({
                                cancel:'重新支付',
                                content:'请确认微信支付是否已完成',
                                confirm:'已完成支付',
                                className:'pay-custom'
                            }).then(()=>{
                               var params = {
                                    user_id:getLStorage('userid'),
                                    live_id:this.$route.params.liveId,
                                    receive_user_id:this.liveDetailsData.user_id
                                }
                                this.$ajax.livePay(params).then(res =>{
                                    console.log(JSON.stringify(res))
                                    if(res.data == '1') {
                                        // this.payLiveState()
                                        this.$toast('支付成功!')
                                        if(this.liveDetailsData.live_statu == 0){
                                            this.liveAppointment()
                                        }
                                        this.payStatusR()
                                    }
                                })
                            }).catch((err)=>{
                                // console.log("error");
                                this.payH()
                            })
                        }
                    })
                }).catch((err)=>{
                    var liveCurUrl = window.location.href;
                    if(liveCurUrl.indexOf('code') > -1) {
                        var liveIdNow = liveCurUrl.indexOf('/live/')[1]
                        var curid = liveCurUrl.split('live/')[1]
                    }
                     var params = {
                        user_id:getLStorage('userid'),
                        live_id:curid || this.$route.params.liveId,
                        receive_user_id:this.liveDetailsData.user_id
                    }
                    this.$ajax.livePay(params).then(res =>{
                        if(res.data == '1') {
                            // this.payLiveState()
                            this.$toast('支付成功!')
                            if(this.liveDetailsData.live_statu == 0){
                                this.liveAppointment()
                            }
                            this.payStatusR()
                        }else{
                            this.payH()
                        }
                    })
                })
            }
        },
        
    },
    mounted(){
        // 若在当前页授权，则授权之后跳转到当前页
        this.getLiveDetails()
        // var url = 'http://zzsyportaltest.mvaas.cn/public/zzsyH5/index.html#/live=8937457854?pay=1'
        // console.log(url)
        // console.log(encodeURIComponent (url))
        // console.log(window.screen.availWidth,window.screen.availHeight)
        // alert(window.screen.availWidth)
        // alert(window.screen.availHeight)
        // var u = navigator.userAgent;
        // var isAndroid = u.indexOf('Android') > -1 || u.indexOf('Adr') > -1; //android终端
        // var isiOS = !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/); //ios终端
        // this.androidFlag = isAndroid
        // this.iosFlag = isiOS
        // 监听播放事件
        // var myVideo = document.getElementById('test')
        // myVideo.addEventListener('play',function(){  
        //     alert(123)
        // });  
        // myVideo.addEventListener('pause',function(){  
        //     alert(456)
        // })
        // var stt = 'dkfjfsjjdfjjkakjfkldslflal.m3u8'
        // console.log(stt.substring(stt.length-5))
        // 实时监听直播状态
        eventVue.$on('liveS', val=>{
            console.log(val)
            this.liveDetailsData.live_statu = val
            // 预告变为直播状态时
            if(val == 1){
                this.appointVideo = false
                this.showVideoFlag = true
                this.headimgstate = false
                // 直播变为结束时
            }else if(val == 5){
                this.headimgstate = true
                this.appointVideo = false
                this.showVideoFlag = false
                this.lF = false
            }
        })
        // 广播免费直播，免费回放时未登录的情况,点播视频或图片的显示
        eventVue.$on('wL',val=> {
            if(val) {
                if(this.liveDetailsData.live_statu == 0) {
                    this.appointVideo = false
                    // this.headimgstate = true
                    this.imgL = true
                }else if(this.liveDetailsData.live_statu == 1 || this.liveDetailsData.live_statu == 2) {
                    this.showVideoFlag = false
                    this.appointVideo = false
                    // this.headimgstate = true
                    this.imgL = true
                }
            }
        })

        this.time = (new Date()).getTime()
        eventVue.$on('cancel', val => {
             this.imgL = false
            if (!this.chatFlag) {
                // 点击遮罩层时的处理
                this.flag = val.cF
                if(is_weixn()) {
                    this.loginState = 'changF'
                }else {
                    this.loginState = 'loginF'
                }
                console.log(this.liveDetailsData.live_before_type)
                // debugger
                document.getElementsByTagName('body')[0].style.overflow= 'visible' 
                document.getElementsByTagName('html')[0].style.overflow= 'visible'
                if(this.liveDetailsData.live_before_type == 0) {
                    this.appointVideo = false
                }else if(this.liveDetailsData.live_before_type == 1 && this.liveDetailsData.live_statu !==5) {
                     document.getElementById('appointvideo').style.display = 'block'
                }
                // if(this.headimgstate && this.show && (!getLStorage('mobile') || getLStorage('mobile') == 'undefined')) {
                //     document.getElementById('appointvideo').style.display = 'none'
                // }
            }else {
                if(this.liveDetailsData.live_statu == 0) {
                    this.appointVideo = true
                    this.headimgstate = false
                }else if(this.liveDetailsData.live_statu == 1 || this.liveDetailsData.live_statu == 2) {
                    this.showVideoFlag = true
                    this.appointVideo = false
                    this.headimgstate = false
                }
            }

            // 调用是否支付
             if(getLStorage('thirdUserInfo')) {
                var thirP = JSON.parse(getLStorage('thirdUserInfo'))
                var thirPUserid = thirP.id
            }else if(getLStorage('mobileUserInfo')){
                var mobileMes = JSON.parse(getLStorage('mobileUserInfo'))
                var thirPUserid = mobileMes.id
            }
            var ruserId = getLStorage('userid')
            if(!ruserId || ruserId == 'undefined') {
                eventVue.$on('useridF',res=>{
                    var liveCurUrl = window.location.href;
                    if(liveCurUrl.indexOf('code') > -1) {
                        var liveIdNow = liveCurUrl.indexOf('/live/')[1]
                        var curid = liveCurUrl.split('live/')[1]
                    }
                    var params = {
                        user_id:val.uId || thirPUserid,
                        live_id:curid ||this.$route.params.liveId,
                        receive_user_id:this.liveDetailsData.user_id
                    }
                })
            }else{
                 var liveCurUrl = window.location.href;
                    if(liveCurUrl.indexOf('code') > -1) {
                        var liveIdNow = liveCurUrl.indexOf('/live/')[1]
                        var curid = liveCurUrl.split('live/')[1]
                    }
                var params = {
                        user_id:ruserId || thirPUserid,
                        live_id:curid || this.$route.params.liveId,
                        receive_user_id:this.liveDetailsData.user_id
                    }
            }
            if(this.liveDetailsData.live_permit == 2) {
                this.$ajax.livePay(params).then(res =>{
                    console.log(JSON.stringify(res))
                    //1代表已经付费，headimgstate不显示图片显示为录像
                    if(res.data == '1') {
                        if(this.liveDetailsData.live_statu == 1) {
                            this.payState = true
                            this.headimgstate = false
                            this.showVideoFlag = true
                            this.chatFlag = true
                            this.showLCFlag = false
                            eventVue.$emit('livebottom',false)
                        }else if(this.liveDetailsData.live_statu == 0 && this.liveDetailsData.live_before_type == 1) {
                            this.payState = true
                            this.headimgstate = false
                            this.showVideoFlag = false
                            this.chatFlag = true
                            this.showLCFlag = false
                            eventVue.$emit('livebottom',false)
                            this.againSee = true
                        }else if(this.liveDetailsData.live_statu == 0 && this.liveDetailsData.live_before_type == 0) {
                            this.payState = true
                            this.headimgstate = true
                            this.show = false
                            this.showVideoFlag = false
                            this.chatFlag = true
                            this.showLCFlag = false
                            eventVue.$emit('livebottom',false)
                            this.againSee = true
                            this.lF = false
                        }else if(this.liveDetailsData.live_statu == 2) {
                            this.appointVideo = true
                            this.chatFlag = true
                            this.lF = false
                        }
                        console.log('登录已付费')
                        
                    }
                })
            }
        })
        
        // 进入直播间自动播放直播
        // document.getElementById('example_video_1').play()
        // console.log(getVideoNode)
        // if(getVideoNode !== null) {
        //     console.log(44444)
        //     getVideoNode.play()
        // }
        // 直播间观看人数
        eventVue.$on('views', val =>{
            if(val > 9999) {
                this.viewsLive = (val/10000).toFixed(2) + '万'
            }else {
                this.viewsLive = val
            }
        })
        // 接收app组件发送过来的邀请点击状态
        eventVue.$on('appToLive',res=>{
            console.log(res)
            this.inviteFlag = res
        })
        // 接收app组件发送过来的底部预约付费的状态
        eventVue.$on('payFT',res=>{
            console.log('app点击了',res)
            if(res) {
                this.pay()
            }
        })
    },
    destroyed() {
        var bSo = document.getElementsByTagName('body')[0]
        var hSo = document.getElementsByTagName('html')[0]
        hSo.style.overflow= 'visible' //处理弹框页面滚动
        bSo.style.overflow= 'visible' //处理弹框页面滚动
        this.liveDetailsData.live_before_type = 'null'
        eventVue.$emit('livebottom',false)
    }
}
</script>
<style lang="scss">
#paya {
    width: 100%;
    height: 100%;
    background: #f6f6f6;
    .topv{
        width: 100%;
    }
}
.live {
    position: absolute;
    top: 0;
    left: 0;
    video {
        width: 100%;
        display: block;
    }
    .pay-wait {
        position: fixed;
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        margin: auto;
        width: 20px;
        height: 20px;
        z-index: 2;
    }
    .start-time {
        width: 100%;
        background: #2D2E35;
        display: flex;
        justify-content: space-between;
        align-items:center;
         @media only screen and (min-width: 320px) {
            height: 40px;
             .start-title {
                color: #9B9B9B;
                padding-left: 1.3rem;
                font-size: 1.2rem;
            }
            .time {
                padding-right: 1.3rem;
                color: #fff;
                .countdown-box {
                    color: #fff;
                    font-size: 2.56rem;
                }
                sub {
                    font-size: 0.9rem;
                    color: #9B9B9B;
                    position: relative;
                    top: -0.35rem;
                }
            }
        }
        @media only screen and (min-width: 360px) {
            height: 5rem;
            .start-title {
                color: #9B9B9B;
                padding-left: 1.5rem;
                font-size: 1.4rem;
            }
            .time {
                padding-right: 1.5rem;
                color: #fff;
                .countdown-box {
                    color: #fff;
                    font-size: 3rem;
                }
                sub {
                    font-size: 1.1rem;
                    color: #9B9B9B;
                    position: relative;
                    top: -0.4rem;
                }
            }
        }
        
    }
    // video {
    //     width: 100%;
    // }
    // #video-player {
    //     height: 18.1rem;
    // }
    @media only screen and (min-width: 320px) {
        #img-login {
            width: 100%;
        }
        #appointvideo {
            width: 100%;
            height: 18.5rem !important;
            object-fit: fill;
            // >div {
            //     height: 18.5rem;
            // }
            // .video-js.vjs-fluid, .video-js.vjs-16-9, .video-js.vjs-4-3, video {
            //     height: 18.5rem;
            // }
        }
    }
     @media only screen and (min-width: 360px) {
        #img-login {
            width: 100%;
        }
        >#appointvideo {
            width: 100%;
            height: 21.1rem !important;
            object-fit: fill;
            >div {
                height: 21.1rem;
            }
            .video-js.vjs-fluid, .video-js.vjs-16-9, .video-js.vjs-4-3, video {
                height: 21.1rem;
            }
        }
    }
     @media only screen and (min-width: 360px) {
        #img-login {
            width: 100%;
        }
        >#appointvideo {
            width: 100%;
            height: 21.1rem !important;
            object-fit: fill;
            >div {
                height: 21.1rem;
            }
            .video-js.vjs-fluid, .video-js.vjs-16-9, .video-js.vjs-4-3, video {
                height: 21.1rem;
            }
        }
    }
     @media only screen and (min-width: 600px) {
        #img-login {
            width: 100%;
        }
        >#appointvideo {
            width: 100%;
            height: 33.9rem !important;
            object-fit: fill;
            >div {
                width: 100%;
                height: 33.9rem;
                // padding-top: 0;
            }
            .video-js.vjs-fluid, .video-js.vjs-16-9, .video-js.vjs-4-3, video {

                height: 33.9rem;
            }
        }
    }
      #appointvideo.vjs-custom-skin .video-js.vjs-paused .vjs-big-play-button {
        width: 52px !important;
        height: 52px !important;
        border-radius: 50%;
        margin-left: -26px;
        line-height: 1.4em !important;
        object-fit: fill;
    }
    // >.start-time {
    //     width: 100%;
    //     background: #2D2E35;
    //     display: flex;
    //     justify-content: space-between;
    //     align-items:center;
    //      @media only screen and (min-width: 320px) {
    //         height: 40px;
    //          .start-title {
    //             color: #9B9B9B;
    //             padding-left: 1.3rem;
    //             font-size: 1.2rem;
    //         }
    //         .time {
    //             padding-right: 1.3rem;
    //             color: #fff;
    //             .countdown-box {
    //                 color: #fff;
    //                 font-size: 2.56rem;
    //             }
    //             sub {
    //                 font-size: 0.9rem;
    //                 color: #9B9B9B;
    //                 position: relative;
    //                 top: -0.35rem;
    //             }
    //         }
    //     }
    //     @media only screen and (min-width: 360px) {
    //         height: 5rem;
    //         .start-title {
    //             color: #9B9B9B;
    //             padding-left: 1.5rem;
    //             font-size: 1.4rem;
    //         }
    //         .time {
    //             padding-right: 1.5rem;
    //             color: #fff;
    //             .countdown-box {
    //                 color: #fff;
    //                 font-size: 3rem;
    //             }
    //             sub {
    //                 font-size: 1.1rem;
    //                 color: #9B9B9B;
    //                 position: relative;
    //                 top: -0.4rem;
    //             }
    //         }
    //     }
        
    // }
    .play-live {
        position: relative;
        img {
            width: 100%;
            @media only screen and (min-width: 320px) {
                height: 18rem;
            }
            @media only screen and (min-width: 360px) {
                height: 21.1rem;
            }
        }
        .live-end {
            width: 100%;
            height: 5rem;
            line-height: 5rem;
            background:rgba(45,46,53,0.6);
            text-align: center;
            font-size: 1.7rem;
            color: #fff;
            position: absolute;
            bottom: 0;
            left: 0;
        }
        &#example_video_1 {
            width: 100%;
            height: 21.1rem;
        }
    }
    .top-live {
        display: flex;
        justify-content: space-between;
        height: 4.4rem;
        align-items: center;
        position: relative;
        background: #fff;
        .views-live {
            position: absolute;
            bottom: -4rem;
            right: 0;
            z-index: 100;
            background:rgba(0,0,0,0.7);
            color: #fff;
            min-width: 9rem;
            height: 2rem;
            line-height: 2rem;
            text-align: center;
            border-radius: 1rem;
            font-size: 1rem;
            margin: 1rem;
            border:1px solid rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            &.appoint-see {
                justify-content: center;
                background: #000000;
                min-width: 7.5rem;
                font-size: 11px;
            }
            i {
                display: inline-block; 
                width: 0.4rem;
                height: 0.4rem;
                border-radius: 50%;
                background: #FF467F;
                margin-left: 0.8rem;
                margin-right: 0.2rem;
            }
        }
        .logo {
            display: inline-block;
            width: 90px;
            height: 25px;
            background: url('images/logo.png') no-repeat;
            background-size: 90px 25px;
            margin-left: 1.5rem;
        }
        .home-personal {
            .personal-center,.home {
                display: inline-block;
                height: 2.7rem;
                width: 7rem;
                line-height: 2.7rem;
                color: #4A4A4A;
                border: 1px solid #979797;
                text-align: center;
                font-size: 1.2rem;
                border-radius: 1.6rem;
                margin-right: 1rem;
                &.goto {
                    color: #FF6633;
                    border-color: #FF6633;
                }
            }
        }
    }
    // #myvideo {
    //     object-fit:fill;
    //     width: 100%;
    //     height: 21.1rem;
    //     display: block;
    // }
    .livehomestate {
        // 预约
        .start-time {
            width: 100%;
            height: 50px;
            background: #2D2E35;
            display: flex;
            justify-content: space-between;
            align-items:center;
            .start-title {
                color: #9B9B9B;
                padding-left: 1.5rem;
                font-size: 1.4rem;
            }
            .time {
                padding-right: 1.5rem;
                color: #fff;
                .countdown-box {
                    color: #fff;
                    font-size: 3rem;
                }
                sub {
                    font-size: 1.1rem;
                    color: #9B9B9B;
                    position: relative;
                    top: -0.4rem;
                }
            }
        }
        .details {
            // padding-bottom: 4.8rem;
            background: #f6f6f6;
            .title {
                border-bottom: 1px solid #f2f2f2;
                .live-title {
                    font-size: 1.7rem;
                    padding: 0.6rem 5.6rem 0.6rem 1.5rem;
                    font-family:PingFangSC-Medium;
                    font-weight: bold;
                    color: #333333;
                    line-height: 2.5rem;
                }
                .start-time-title {
                    font-size: 1.3rem;
                    color: #999;
                    padding: 0.6rem 0 0.6rem 1.5rem;
                    &.end {
                        padding-bottom: 2rem;
                    }
                }
                .money {
                    padding: 0 0 1.5rem 1.5rem;
                    img {
                        width: 41px;
                        height: 20px;
                    }
                    span {
                        color: #FF6634;
                        &.no-money {
                            color: #34A853;
                            font-size: 1.2rem;
                        }
                    }
                }
            }
            .introduction {
                &.disance {
                    padding-bottom: 4.8rem;
                }
                h5 {
                    font-size: 1.6rem;
                    color: #333;
                    padding: 1.5rem;
                    line-height: 2.3rem;
                }
                .int-img {
                    img {
                        width: 100%;
                        height: 21rem;
                        padding: 0 3%;
                    }
                    p {
                        font-size:1.4rem;
                        line-height: 2.5rem;
                    }
                }
                p {
                    font-size: 1.4rem;
                    color: #333;
                    line-height: 2.5rem;
                    padding: 0 1.5rem;
                }
                .no-introduct {
                   display: flex;
                   justify-content: center;
                }
                 p{
                    text-align: center;
                    padding-top: 1.1rem;
                    padding-bottom: 4.8rem;
                    color: #9B9B9B;
                    font-size: 1.4rem;
                   }
            }
        }
            // .bottom-invitation-pay {
            //     width: 100%;
            //     height: 4.8rem;
            //     position: fixed;
            //     // position: absolute;
            //     bottom: 0;
            //     left: 0;
            //     display: flex;
            //     color: #fff;
            //     text-align: center;
            //     .invitation {
            //         flex: 1;
            //         background: #576AF4;
            //         line-height: 4.8rem;
            //     }
            //     .pay {
            //         flex: 2;
            //         background: #FF6633;
            //         line-height: 4.8rem;
            //     }
            //     // .payh {
            //     //     background: yellow;
            //     //     color: #000;
            //     //     flex: 2;
            //     // }
            // }
        // .mask-live {
        //     position: fixed;
        //     top: 0;
        //     left: 0;
        //     width: 100%;
        //     height: 100%;
        //     background-color: rgba(0,0,0,.5);
        //     z-index: 1;
        // }
    }
    // 回放及直播
    .livehome-wrapper {
        // width: 100%;
        // position: absolute;
        // top: 25.5rem;
        .livehome {
            display: flex;
            justify-content: center;
            align-items:center;
            background: #fff;
            @media only screen and (min-width: 320px) {
                height: 3.75rem;
                .chat-detail-se {
                    .tabs-item {
                        padding: 10px 2.8rem;
                        font-size: 1.3rem;
                        color:#111;
                        display: flex;
                        align-items: center;
                        &.active {
                            color: #FF6633;
                            span {
                                border-bottom: 3px solid #FF6633;
                                display: inline-block;
                                height: 3.4rem;
                                line-height: 3.4rem;
                            }
                        }
                    }
                }
            }
            @media only screen and (min-width:360px) {
               height: 4.4rem;
               .chat-detail-se {
                    .tabs-item {
                        padding: 12px 2.8rem;
                        font-size: 1.3rem;
                        color:#111;
                        display: flex;
                        align-items: center;
                        &.active {
                            color: #FF6633;
                            span {
                                border-bottom: 3px solid #FF6633;
                                display: inline-block;
                                height: 4rem;
                                line-height: 4rem;
                            }
                        }
                    }
                }
            }
        }
    }
    // 邀请
.invite-enter-active{
	/*从下到上*/
	animation:slideTop .4s;
}


.invite-leave-active{

	/*从上到下*/
	animation:slideBottom .4s;
}


@keyframes slideTop{

	0%{
		transform: translate(0,100%);
	}

	100%{
		transform: translate(0,0);
	}
}

@keyframes slideBottom{

	0%{
		transform: translate(0,0);
	}

	100%{
		transform: translate(0,100%);
	}
}
.live-invite1 {
    height: 14.8rem;
    width: 100%;
    background: #fff;
    position: fixed;
    bottom: 0;
    left: 0;
    z-index: 15;
    .card {
        width: 100%;
        height: 10.5rem;
        border-bottom: 1px solid #E3E3E7;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        span {
            color: #909090;
            margin-top: 0.3rem;
        }
        img {
            width: 4.8rem;
            height: 4.8rem;
        }
    }
    .cancel {
        width: 100%;
        height: 4.1rem;
        line-height: 4.1rem;
        text-align: center;
        color: #9B9B9B;
        font-size: 1.5rem;
    }
}
.mask-live,.mask-wait {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    z-index: 1;
}
}
#svideo.vjs-custom-skin .video-js.vjs-paused .vjs-big-play-button {
    width: 52px !important;
    height: 52px !important;
    border-radius: 50%;
    margin-left: -26px;
    line-height: 1.4em !important;
}
.container1 > div, .container2 > div, .container3 > div {
    background-color: #fff !important;
}
.no {
    background: #000;
    height: 100%;
    .spinner{
        top: 150px;
    }
}

</style>


